   #!/bin/bash

# Script para configurar automáticamente un servidor DNS con BIND9
# Solicita los datos necesarios al usuario antes de proceder.

# Función para validar una dirección IP
validate_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        return 0
    else
        return 1
    fi
}

# Solicitar datos al usuario
echo "Configuración del servidor DNS con BIND9"
read -p "Introduce la IP del servidor DNS (por ejemplo, 192.168.222.2): " server_ip
while ! validate_ip $server_ip; do
    read -p "IP no válida. Introduce una IP válida: " server_ip
done

read -p "Introduce la IP del router (por ejemplo, 192.168.222.1): " router_ip
while ! validate_ip $router_ip; do
    read -p "IP no válida. Introduce una IP válida: " router_ip
done

read -p "Introduce el nombre de dominio (por ejemplo, redesplus.es): " domain_name
read -p "¿Cuántos clientes deseas configurar? " num_clients

client_ips=()
client_names=()
for ((i=1; i<=$num_clients; i++)); do
    read -p "Introduce la IP del cliente $i (por ejemplo, 192.168.222.51): " client_ip
    while ! validate_ip $client_ip; do
        read -p "IP no válida. Introduce una IP válida: " client_ip
    done
    client_ips+=("$client_ip")

    read -p "Introduce el nombre del cliente $i (por ejemplo, cliente1): " client_name
    client_names+=("$client_name")
done

# 1. Instalación de BIND9 y herramientas necesarias
echo "Instalando BIND9 y resolvconf..."
apt update
apt install -y bind9 resolvconf

# 2. Configuración de Netplan
echo "Configurando Netplan..."
cat <<EOF > /etc/netplan/01-netcfg.yaml
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: no
      addresses:
        - $server_ip/24
      gateway4: $router_ip
      nameservers:
        addresses:
          - $server_ip
EOF

netplan try
netplan apply

# 3. Configuración de systemd-resolved
echo "Configurando systemd-resolved..."
cat <<EOF > /etc/systemd/resolved.conf
[Resolve]
DNS=$server_ip
Domains=$domain_name
EOF

systemctl daemon-reload
systemctl restart systemd-networkd
systemctl restart systemd-resolved

rm -f /etc/resolv.conf
ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf

# 4. Configuración del servicio de nombres (nsswitch.conf)
echo "Configurando nsswitch.conf..."
sed -i 's/^hosts:.*/hosts: dns files/' /etc/nsswitch.conf

# 5. Configuración de zonas DNS en BIND9
echo "Configurando zonas DNS en BIND9..."

# Crear zonas en named.conf.local
cat <<EOF > /etc/bind/named.conf.local
zone "$domain_name" {
    type master;
    file "/etc/bind/db.$domain_name";
};

zone "$(echo $server_ip | awk -F. '{print $3"."$2"."$1}').in-addr.arpa" {
    type master;
    file "/etc/bind/db.$(echo $server_ip | awk -F. '{print $3"."$2"."$1}')";
};
EOF

# Crear archivo de zona para el dominio
cp /etc/bind/db.local /etc/bind/db.$domain_name
cat <<EOF > /etc/bind/db.$domain_name
\$TTL 604800
@ IN SOA servidor.$domain_name. root.$domain_name. (
    2 ; Serial
    604800 ; Refresh
    86400 ; Retry
    2419200 ; Expire
    604800 ) ; Negative Cache TTL

@ IN NS servidor.$domain_name.
servidor IN A $server_ip
EOF

for ((i=0; i<$num_clients; i++)); do
    echo "${client_names[$i]} IN A ${client_ips[$i]}" >> /etc/bind/db.$domain_name
done

# Crear archivo de zona para resolución inversa
cp /etc/bind/db.$domain_name /etc/bind/db.$(echo $server_ip | awk -F. '{print $3"."$2"."$1}')
cat <<EOF > /etc/bind/db.$(echo $server_ip | awk -F. '{print $3"."$2"."$1}')
\$TTL 604800
@ IN SOA servidor.$domain_name. root.$domain_name. (
    2 ; Serial
    604800 ; Refresh
    86400 ; Retry
    2419200 ; Expire
    604800 ) ; Negative Cache TTL

@ IN NS servidor.$domain_name.
$(echo $server_ip | awk -F. '{print $4}') IN PTR servidor.$domain_name.
EOF

for ((i=0; i<$num_clients; i++)); do
    echo "$(echo ${client_ips[$i]} | awk -F. '{print $4}') IN PTR ${client_names[$i]}.$domain_name." >> /etc/bind/db.$(echo $server_ip | awk -F. '{print $3"."$2"."$1}')
done

# 6. Verificación y reinicio del servicio DNS
echo "Verificando configuración de BIND9..."
named-checkconf /etc/bind/named.conf.local
named-checkzone $domain_name /etc/bind/db.$domain_name
named-checkzone $(echo $server_ip | awk -F. '{print $3"."$2"."$1}').in-addr.arpa /etc/bind/db.$(echo $server_ip | awk -F. '{print $3"."$2"."$1}')

echo "Reiniciando servicio BIND9..."
systemctl restart bind9
systemctl status bind9

# 7. Pruebas finales
echo "Realizando pruebas de resolución DNS..."
nslookup servidor.$domain_name
nslookup $server_ip

echo "¡Configuración del servidor DNS completada!"
